name: Do Not Merge

on:
  workflow_call:
    inputs:
      label:
        required: false
        type: string
        default: "do not merge"
      comment:
        required: false
        type: boolean
        default: true

jobs:
  do-not-merge:
    name: Check
    runs-on: ubuntu-slim

    steps:
      - name: Find Comment
        if: inputs.comment
        uses: peter-evans/find-comment@b30e6a3c0ed37e7c023ccd3f1db5c6c0b0c23aad # v4.0.0
        id: comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: ⚠️ **This Pull Request is not ready to be merged.**

      - name: Comment on PR
        if: inputs.comment && contains(github.event.pull_request.labels.*.name, inputs.label) && steps.comment.outputs.comment-id == ''
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ⚠️ **This Pull Request is not ready to be merged.**

            Remove the label '${{ inputs.label }}' to proceed.

      - name: Delete Comment
        if: inputs.comment && !contains(github.event.pull_request.labels.*.name, inputs.label) && steps.comment.outputs.comment-id != ''
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.deleteComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: ${{ steps.comment.outputs.comment-id }}
            })

      - name: Fail if label exists to block merge
        if: contains(github.event.pull_request.labels.*.name, inputs.label)
        run: |
          echo "This PR has the label '${{ inputs.label }}'."
          exit 1
