name: GitOps

on:
  workflow_call:
    inputs:
      docker-registry:
        required: false
        type: string
        default: "registry.staffbase.com"
      docker-build-args:
        required: false
        type: string
      docker-build-target:
        required: false
        type: string
      docker-build-outputs:
        required: false
        type: string
        description: "Custom output destinations for docker build (e.g., type=registry,push=true,compression=gzip,force-compression=true). Required for DHI images."
      docker-build-platform:
        required: false
        type: string
        description: "A build platform (e.g., linux/amd64, linux/arm64). If multiple platforms are specified, the action will fail as it does not support cross-compilation."
        default: "linux/amd64"
      docker-build-provenance:
        required: false
        type: string
        default: "false"
      docker-disable-retagging:
        required: false
        type: string
        default: "false"
      docker-file:
        required: false
        type: string
        default: "./Dockerfile"
      docker-image:
        required: false
        type: string
        default: sb-images/${{ github.event.repository.name }}
      docker-custom-tag:
        required: false
        type: string
      gitops-dev:
        required: false
        type: string
      gitops-stage:
        required: false
        type: string
      gitops-prod:
        required: false
        type: string
      gitops-organization:
        required: false
        type: string
        default: ${{ github.repository_owner }}
      gitops-repository:
        required: false
        type: string
        default: "mops"
      gitops-user:
        required: false
        type: string
        default: "staffbase-actions"
      gitops-email:
        required: false
        type: string
        default: "staffbase-actions[bot]@users.noreply.github.com"
      upwind-client-id:
        required: false
        type: string
      runs-on:
        required: false
        type: string
        default: "ubuntu-24.04"
      upwind-organization-id:
        required: false
        type: string
      working-directory:
        required: false
        type: string
        default: "."
    # waiting for: https://github.com/github-community/community/discussions/17554
    secrets:
      docker-username:
        required: false
      docker-password:
        required: false
      docker-build-secrets:
        required: false
      docker-build-secret-files:
        required: false
      gitops-token:
        required: false
      gonosumdb:
        required: false
      app-id:
        required: false
      private-key:
        required: false
      upwind-client-secret:
        required: false

jobs:
  gitops:
    name: GitOps
    runs-on: ${{ inputs.runs-on }}
    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')

    env:
      USING_APP_CREDENTIALS: ${{ secrets.app-id != '' && secrets.private-key != '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Get App Token
        if: ${{ env.USING_APP_CREDENTIALS == 'true' }}
        uses: actions/create-github-app-token@7e473efe3cb98aa54f8d4bac15400b15fad77d94 # v2.2.0
        id: get_token
        with:
          app-id: ${{ secrets.app-id }}
          private-key: ${{ secrets.private-key }}
          owner: ${{inputs.gitops-organization }}

      - name: GitOps (build, push and deploy a new Docker image)
        id: gitops
        uses: Staffbase/gitops-github-action@500933363014dc38ab352417d07bcc6b6e2d64bc # v6.6
        with:
          docker-registry: ${{ inputs.docker-registry }}
          docker-username: ${{ secrets.docker-username }}
          docker-password: ${{ secrets.docker-password }}
          docker-build-args: |
            ${{ inputs.docker-build-args }}
            GONOSUMDB=${{ vars.gonosumdb }}
          docker-build-secrets: ${{ secrets.docker-build-secrets }}
          docker-build-secret-files: ${{ secrets.docker-build-secret-files }}
          docker-build-target: ${{ inputs.docker-build-target }}
          docker-build-outputs: ${{ inputs.docker-build-outputs }}
          docker-build-platforms: ${{ inputs.docker-build-platform }}
          docker-build-provenance: ${{ inputs.docker-build-provenance }}
          docker-disable-retagging: ${{ inputs.docker-disable-retagging }}
          docker-file: ${{ inputs.docker-file }}
          docker-image: ${{ inputs.docker-image }}
          docker-custom-tag: ${{ inputs.docker-custom-tag }}
          gitops-organization: ${{ inputs.gitops-organization }}
          gitops-repository: ${{ inputs.gitops-repository }}
          gitops-user: ${{ inputs.gitops-user }}
          gitops-email: ${{ inputs.gitops-email }}
          gitops-token: ${{ env.USING_APP_CREDENTIALS == 'true' && steps.get_token.outputs.token || secrets.gitops-token }}
          gitops-dev: ${{ inputs.gitops-dev }}
          gitops-stage: ${{ inputs.gitops-stage }}
          gitops-prod: ${{ inputs.gitops-prod }}
          upwind-client-id: ${{ inputs.upwind-client-id }}
          upwind-client-secret: ${{ secrets.upwind-client-secret }}
          upwind-organization-id: ${{ inputs.upwind-organization-id }}
          working-directory: ${{ inputs.working-directory }}
