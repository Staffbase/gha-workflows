name: GitOps

on:
  workflow_call:
    inputs:
      docker-build-args:
        required: false
        type: string
      docker-build-target:
        required: false
        type: string
      docker-file:
        required: false
        type: string
        default: './Dockerfile'
      docker-image:
        required: false
        type: string
        default: private/${{ github.event.repository.name }}
      gitops-dev:
        required: false
        type: string
      gitops-stage:
        required: false
        type: string
      gitops-prod:
        required: false
        type: string
    secrets:
      docker-username:
        required: false
      docker-password:
        required: false
      gitops-token:
        required: false
      npm-token:
        required: false
      goproxy:
        required: false
      gonosumdb:
        required: false

jobs:
  gitops:

    name: GitOps
    runs-on: ubuntu-22.04

    if: github.ref == 'refs/heads/dev' || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: GitOps (build, push and deploy a new Docker image)
        uses: Staffbase/gitops-github-action@v4.1
        with:
          docker-username: ${{ secrets.docker-username }}
          docker-password: ${{ secrets.docker-password }}
          # remove npm token, goproxy, gonosumdb if feature is available: https://github.com/github-community/community/discussions/17554
          docker-build-args: |
            ${{ inputs.docker-build-args }}
            NPM_TOKEN=${{ secrets.npm-token }}
            GOPROXY=${{ secrets.goproxy }}
            GONOSUMDB=${{ secrets.gonosumdb }}
          docker-build-target: ${{ inputs.docker-build-target }}
          docker-image: ${{ inputs.docker-image }}
          docker-file: ${{ inputs.docker-file }}
          gitops-token: ${{ secrets.gitops-token }}
          gitops-dev: ${{ inputs.gitops-dev }}
          gitops-stage: ${{ inputs.gitops-stage }}
          gitops-prod: ${{ inputs.gitops-prod }}
